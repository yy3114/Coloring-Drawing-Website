```html
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼è‘—è‰²æœ¬ (ä¿®æ­£ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', 'sans-serif';
            background-color: #f3f4f6; 
        }
        
        /* ç•«å¸ƒå®¹å™¨ï¼šè² è²¬é™åˆ¶è¦–çª—å’Œæä¾›è£å‰ªé‚Šç•Œ */
        #canvasContainer {
            overflow: hidden; 
            position: relative;
            max-width: 512px;
            max-height: 512px;
            margin: 0 auto;
            border: 4px solid #3b82f6;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 100%;
            aspect-ratio: 1 / 1; 
        }

        #coloringCanvas {
            touch-action: none; /* ç¦ç”¨ç€è¦½å™¨é»˜èªçš„è§¸æ§è¡Œç‚º (é‡è¦) */
            cursor: pointer;
            transform-origin: 0 0; /* ç¸®æ”¾å’Œä½ç§»çš„åŸºæº–é»åœ¨å·¦ä¸Šè§’ */
            transition: transform 0.1s ease-out; 
            width: 100%;
            height: 100%;
            will-change: transform; 
        }
        
        /* é¡è‰²é¸æ“‡å™¨æ¨£å¼ */
        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 3.5rem; 
            height: 3.5rem; 
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
        }
        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border-radius: 9999px; border: 4px solid white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        #colorPicker::-moz-color-swatch-wrapper { padding: 0; }
        #colorPicker::-moz-color-swatch { border-radius: 9999px; border: 4px solid white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }

        .preset-color {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
            border: 2px solid transparent;
        }
        .preset-color:hover {
            transform: scale(1.1);
        }
        .preset-color.selected {
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px #bfdbfe; 
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">ğŸ–ï¸ é»æ“Šå¡«è‰²äº’å‹•å¼è‘—è‰²æœ¬</h1>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white p-4 rounded-xl shadow-lg mb-6 space-y-4">
            
            <!-- é¡è‰²é¸æ“‡å€ -->
            <div class="flex flex-col space-y-3">
                <label class="text-lg font-semibold text-gray-700">ğŸ¨ é¸æ“‡é¡è‰²:</label>
                
                <div class="flex flex-wrap items-center space-x-3">
                    <input type="color" id="colorPicker" value="#FF6347" class="transition duration-200 hover:scale-105">

                    <div id="presetColors" class="flex flex-wrap items-center space-x-2 space-y-2 ml-4">
                        <!-- å¸¸ç”¨é¡è‰² -->
                        <div id="commonColors" class="flex flex-wrap space-x-2 space-y-2">
                            <div class="preset-color bg-red-500" data-color="#EF4444" title="ç´…è‰²"></div>
                            <div class="preset-color bg-pink-500" data-color="#EC4899" title="ç²‰è‰²"></div>
                            <div class="preset-color bg-orange-500" data-color="#F97316" title="æ©˜è‰²"></div>
                            <div class="preset-color bg-yellow-500" data-color="#F59E0B" title="é»ƒè‰²"></div>
                            <div class="preset-color bg-lime-500" data-color="#84CC16" title="çŸ³ç°ç¶ "></div>
                            <div class="preset-color bg-green-500" data-color="#10B981" title="ç¶ è‰²"></div>
                            <div class="preset-color bg-cyan-500" data-color="#06B6D4" title="é’è‰²"></div>
                            <div class="preset-color bg-blue-500" data-color="#3B82F6" title="è—è‰²"></div>
                            <div class="preset-color bg-indigo-500" data-color="#6366F1" title="é›è—"></div>
                            <div class="preset-color bg-purple-500" data-color="#8B5CF6" title="ç´«è‰²"></div>
                            <div class="preset-color bg-gray-500" data-color="#6B7280" title="ä¸­ç°"></div>
                            <div class="preset-color bg-black" data-color="#000000" title="é»‘è‰²"></div>
                            <div class="preset-color bg-white border-gray-300 border" data-color="#FFFFFF" title="ç™½è‰²/æ©¡çš®æ“¦"></div>
                        </div>
                        <button id="moreColorsBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-full transition duration-200">æ›´å¤šé¡è‰²</button>
                        <!-- é¡å¤–é¡è‰² (éš±è—) -->
                        <div id="extraColors" class="flex flex-wrap space-x-2 space-y-2 hidden">
                            <div class="preset-color bg-red-300" data-color="#FCA5A5" title="æ·ºç´…"></div>
                            <div class="preset-color bg-red-700" data-color="#B91C1C" title="æ·±ç´…"></div>
                            <div class="preset-color bg-pink-300" data-color="#F9A8D4" title="æ·ºç²‰"></div>
                            <div class="preset-color bg-pink-700" data-color="#BE185D" title="æ·±ç²‰"></div>
                            <div class="preset-color bg-orange-300" data-color="#FDBA74" title="æ·ºæ©˜"></div>
                            <div class="preset-color bg-orange-700" data-color="#C2410C" title="æ·±æ©˜"></div>
                            <div class="preset-color bg-yellow-300" data-color="#FCD34D" title="æ·ºé»ƒ"></div>
                            <div class="preset-color bg-yellow-700" data-color="#B45309" title="æ·±é»ƒ"></div>
                            <div class="preset-color bg-lime-300" data-color="#BEF264" title="æ·ºçŸ³ç°ç¶ "></div>
                            <div class="preset-color bg-lime-700" data-color="#4D7C0F" title="æ·±çŸ³ç°ç¶ "></div>
                            <div class="preset-color bg-green-300" data-color="#6EE7B7" title="æ·ºç¶ "></div>
                            <div class="preset-color bg-green-700" data-color="#047857" title="æ·±ç¶ "></div>
                            <div class="preset-color bg-cyan-300" data-color="#67E8F9" title="æ·ºé’"></div>
                            <div class="preset-color bg-cyan-700" data-color="#0E7490" title="æ·±é’"></div>
                            <div class="preset-color bg-blue-300" data-color="#93C5FD" title="æ·ºè—"></div>
                            <div class="preset-color bg-blue-700" data-color="#1D4ED8" title="æ·±è—"></div>
                            <div class="preset-color bg-indigo-300" data-color="#A5B4FC" title="æ·ºé›è—"></div>
                            <div class="preset-color bg-indigo-700" data-color="#4338CA" title="æ·±é›è—"></div>
                            <div class="preset-color bg-purple-300" data-color="#C4B5FD" title="æ·ºç´«"></div>
                            <div class="preset-color bg-purple-700" data-color="#5B21B6" title="æ·±ç´«"></div>
                            <div class="preset-color bg-gray-300" data-color="#D1D5DB" title="æ·ºç°"></div>
                            <div class="preset-color bg-gray-700" data-color="#374151" title="æ·±ç°"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¡è‰²æ·±æ·ºèª¿æ•´ -->
            <div class="flex flex-col space-y-3 pt-2 border-t border-gray-100">
                <div class="flex items-center space-x-3">
                    <label class="text-sm text-gray-600 font-medium whitespace-nowrap">ğŸŒ— é¡è‰²æ·±æ·º (0-100):</label>
                    <input type="range" id="shadeRange" min="0" max="100" value="50" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="shadeValue" class="text-sm font-bold text-blue-600 w-8 text-right">50</span>
                </div>
            </div>

            <!-- ç¸®æ”¾èˆ‡å®¹å¿åº¦è¨­å®š -->
            <div class="flex flex-col space-y-3 pt-2 border-t border-gray-100">
                <div class="flex items-center space-x-3">
                    <div id="selectedColorDisplay" class="w-6 h-6 rounded-full border-2 border-gray-400 shadow-inner" style="background-color: #FF6347;"></div>
                    <span class="text-gray-500 font-medium">ç•¶å‰é¸è‰²</span>
                </div>
                
                <!-- ç¸®æ”¾æ§åˆ¶ -->
                <div class="flex items-center space-x-3">
                    <label class="text-sm text-gray-600 font-medium whitespace-nowrap">ğŸ” ç•«å¸ƒç¸®æ”¾:</label>
                    <button id="zoomOutBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full font-bold" onclick="changeZoom(-0.25)">-</button>
                    <span id="zoomLevel" class="text-sm font-bold text-blue-600 w-10 text-center">100%</span>
                    <button id="zoomInBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full font-bold" onclick="changeZoom(0.25)">+</button>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-full transition duration-200" onclick="resetZoom()">é‡ç½®</button>
                </div>

                <!-- å®¹å¿åº¦æ»‘æ¡¿ -->
                <div class="flex items-center space-x-2">
                    <label for="toleranceRange" class="text-sm text-gray-600 whitespace-nowrap">ğŸ’¦ å¡«è‰²å®¹éŒ¯åº¦ (0-100):</label>
                    <input type="range" id="toleranceRange" min="0" max="100" value="32" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="toleranceValue" class="text-sm font-bold text-blue-600 w-8 text-right">32</span>
                </div>
            </div>
            
            <!-- æ¸…é™¤æŒ‰éˆ• -->
            <button id="clearCanvasBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md w-full" onclick="clearCanvas()">
                æ¸…é™¤æ‰€æœ‰å¡«è‰²
            </button>
        </div>

        <!-- ç•«å¸ƒå€åŸŸ (å¤–å±¤å®¹å™¨è² è²¬è¦–çª—) -->
        <div id="canvasContainer" class="w-full aspect-square max-w-lg mx-auto relative rounded-xl border-4 border-blue-500 shadow-lg">
            <canvas id="coloringCanvas" width="512" height="512"></canvas>
            <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-gray-900/50 rounded-xl hidden">
                <div class="text-white text-xl font-bold p-4 rounded-lg bg-black/50 flex items-center space-x-3">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span>è¼‰å…¥ç·šç¨¿ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="messageBox" class="p-3 bg-blue-100 text-blue-700 rounded-lg mt-6 text-center hidden" role="alert"></div>
    </div>

    <script>
        // --- è®Šæ•¸è¨­ç½® ---
        const IMAGE_URL = 'https://i.postimg.cc/VNQhLmjs/1759711736389.jpg'; 
        const CANVAS_SIZE = 512;

        const canvas = document.getElementById('coloringCanvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const ctx = canvas.getContext('2d');
        canvas.width = CANVAS_SIZE;
        canvas.height = CANVAS_SIZE;

        const colorPicker = document.getElementById('colorPicker');
        const selectedColorDisplay = document.getElementById('selectedColorDisplay');
        const toleranceRange = document.getElementById('toleranceRange');
        const toleranceValueSpan = document.getElementById('toleranceValue');
        const shadeRange = document.getElementById('shadeRange');
        const shadeValueSpan = document.getElementById('shadeValue');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const zoomLevelSpan = document.getElementById('zoomLevel');
        
        let originalImageData = null; 
        let currentZoom = 1.0; 
        let offsetX = 0; // ç•«å¸ƒä½ç§» (styled px å–®ä½)
        let offsetY = 0; 
        
        let isDragging = false;
        let dragStartX = 0; 
        let dragStartY = 0; 
        const DRAG_THRESHOLD = 5; 
        let totalMoved = 0; 

        // --- ç¸®æ”¾å’Œæ‹–æ›³æ§åˆ¶ ---

        function applyTransform() {
            canvas.style.transform = `scale(${currentZoom}) translate(${offsetX}px, ${offsetY}px)`;
        }

        function clampOffset() {
            const containerSize = canvasContainer.clientWidth; // å‡è¨­å¯¬é«˜ç›¸åŒ
            const styledSize = containerSize; // canvas width 100%
            const scaledSize = styledSize * currentZoom;
            
            // X è»¸é™åˆ¶
            if (scaledSize > containerSize) {
                const minPanX = (containerSize - scaledSize) / currentZoom;
                const maxPanX = 0;
                offsetX = Math.max(minPanX, Math.min(maxPanX, offsetX));
            } else {
                offsetX = (containerSize - scaledSize) / (2 * currentZoom);
            }

            // Y è»¸é™åˆ¶
            if (scaledSize > containerSize) {
                const minPanY = (containerSize - scaledSize) / currentZoom;
                const maxPanY = 0;
                offsetY = Math.max(minPanY, Math.min(maxPanY, offsetY));
            } else {
                offsetY = (containerSize - scaledSize) / (2 * currentZoom);
            }
        }

        function changeZoom(delta) {
            let newZoom = currentZoom + delta;
            newZoom = Math.max(1.0, Math.min(4.0, newZoom));
            currentZoom = newZoom;
            
            clampOffset();
            applyTransform();

            zoomLevelSpan.textContent = `${Math.round(currentZoom * 100)}%`;
            if (currentZoom > 1.0) {
                 showMessage("ç•«å¸ƒå·²æ”¾å¤§ã€‚ç¾åœ¨å¯ä»¥æ‹–æ›³ç•«å¸ƒä¾†ç§»å‹•è¦–åœ–ã€‚", 'info');
            } else {
                 showMessage("ç•«å¸ƒå·²é‡ç½®ç‚º 100% ç¸®æ”¾ã€‚", 'info');
            }
        }

        function resetZoom() {
            currentZoom = 1.0;
            offsetX = 0;
            offsetY = 0;
            clampOffset(); 
            applyTransform();
            zoomLevelSpan.textContent = `100%`;
            showMessage("ç•«å¸ƒå·²é‡ç½®ç‚º 100% ç¸®æ”¾ã€‚", 'info');
        }

        // --- æ‹–æ›³äº‹ä»¶è™•ç† ---

        function getClientCoords(event) {
            if (event.touches && event.touches.length) {
                return { x: event.touches[0].clientX, y: event.touches[0].clientY };
            }
            return { x: event.clientX, y: event.clientY };
        }

        function handleDragStart(event) {
            isDragging = true;
            totalMoved = 0;
            const coords = getClientCoords(event);
            dragStartX = coords.x;
            dragStartY = coords.y;
            
            if (currentZoom > 1.0) {
                 canvas.style.cursor = 'grabbing';
            }
            
            if (event.type === 'touchstart') {
                event.preventDefault(); 
            }
        }

        function handleDragMove(event) {
            if (!isDragging) return;

            const coords = getClientCoords(event);
            
            const screenDx = coords.x - dragStartX;
            const screenDy = coords.y - dragStartY;
            
            totalMoved += Math.sqrt(screenDx * screenDx + screenDy * screenDy);

            if (currentZoom > 1.0) {
                const dx = screenDx / currentZoom;
                const dy = screenDy / currentZoom;
                
                offsetX += dx;
                offsetY += dy;
                
                clampOffset(); 
                applyTransform();

                dragStartX = coords.x;
                dragStartY = coords.y;
            }
            
            if (event.type === 'touchmove') {
                 event.preventDefault();
            }
        }

        function handleDragEnd(event) {
            if (isDragging) {
                isDragging = false;
                canvas.style.cursor = 'pointer';

                if (totalMoved < DRAG_THRESHOLD) {
                    handleCanvasColoring(event);
                }
            }
            totalMoved = 0;
        }

        // --- ç•«å¸ƒé»æ“Š/å¡«è‰²äº‹ä»¶ ---

        function handleCanvasColoring(event) {
            if (!originalImageData) {
                showMessage("ç·šç¨¿å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™ã€‚", 'error');
                return;
            }
            
            const coords = event.changedTouches && event.changedTouches.length 
                ? { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY }
                : { x: event.clientX, y: event.clientY };

            const rect = canvasContainer.getBoundingClientRect();

            const x_client_rel = coords.x - rect.left;
            const y_client_rel = coords.y - rect.top;

            const containerSize = canvasContainer.clientWidth;
            const pixelRatio = CANVAS_SIZE / containerSize;

            const styledX = (x_client_rel / currentZoom) - offsetX;
            const styledY = (y_client_rel / currentZoom) - offsetY;

            const x = Math.floor(styledX * pixelRatio);
            const y = Math.floor(styledY * pixelRatio);

            if (x < 0 || x >= CANVAS_SIZE || y < 0 || y >= CANVAS_SIZE) {
                return;
            }

            const selectedHex = colorPicker.value;
            let fillColor = hexToRgbaArray(selectedHex);

            const shade = parseInt(shadeRange.value) / 100;
            fillColor = adjustShade(fillColor, shade);

            const tolerance = parseInt(toleranceRange.value);

            floodFill(x, y, fillColor, tolerance);
        }


        // --- è¼”åŠ©å‡½æ•¸ ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-yellow-100', 'text-yellow-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'info') {
                 messageBox.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                 messageBox.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 5000);
        }

        function hexToRgbaArray(hex) {
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            return [r, g, b, 255]; 
        }

        function adjustShade(color, shade) {
            const factor = shade * 2;
            const [r, g, b, a] = color;
            return [
                Math.min(255, Math.max(0, Math.floor(r * factor))),
                Math.min(255, Math.max(0, Math.floor(g * factor))),
                Math.min(255, Math.max(0, Math.floor(b * factor))),
                a
            ];
        }

        function getPixelIndex(x, y) {
            return (y * CANVAS_SIZE + x) * 4;
        }

        function getPixelColor(data, x, y) {
            const i = getPixelIndex(x, y);
            return [data[i], data[i + 1], data[i + 2], data[i + 3]];
        }

        function colorsMatchWithTolerance(color1, color2, tolerance) {
            const rDiff = color1[0] - color2[0];
            const gDiff = color1[1] - color2[1];
            const bDiff = color1[2] - color2[2];
            const distSq = rDiff * rDiff + gDiff * gDiff + bDiff * bDiff;
            const toleranceSq = tolerance * tolerance * 3; 
            return distSq <= toleranceSq;
        }

        function floodFill(startX, startY, fillColor, tolerance) {
            if (!originalImageData) return;
            const imageData = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            const data = imageData.data;
            const targetColor = getPixelColor(data, startX, startY);
            
            if (colorsMatchWithTolerance(targetColor, fillColor, 0)) {
                return;
            }
            const stack = [[startX, startY]];
            const processed = new Uint8Array(CANVAS_SIZE * CANVAS_SIZE); 

            while (stack.length) {
                const [x, y] = stack.pop();
                const pixelIndex = y * CANVAS_SIZE + x;
                if (x < 0 || x >= CANVAS_SIZE || y < 0 || y >= CANVAS_SIZE) { continue; }
                if (processed[pixelIndex] === 1 || processed[pixelIndex] === 2) { continue; }
                
                const currentColor = getPixelColor(data, x, y);

                if (colorsMatchWithTolerance(currentColor, targetColor, tolerance)) {
                    processed[pixelIndex] = 1; 

                    const i = getPixelIndex(x, y);
                    data[i] = fillColor[0];     
                    data[i + 1] = fillColor[1]; 
                    data[i + 2] = fillColor[2]; 
                    data[i + 3] = fillColor[3]; 

                    stack.push([x + 1, y]); 
                    stack.push([x - 1, y]); 
                    stack.push([x, y + 1]); 
                    stack.push([x, y - 1]); 
                } else {
                    processed[pixelIndex] = 2; 
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function clearCanvas() {
            if (originalImageData) {
                ctx.putImageData(originalImageData, 0, 0);
                showMessage("å·²æ¸…é™¤æ‰€æœ‰å¡«è‰²ï¼Œæ¢å¾©åŸå§‹ç·šç¨¿ã€‚", 'info');
            }
        }

        function loadImage() {
            loadingIndicator.classList.remove('hidden');
            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            img.onload = function() {
                ctx.drawImage(img, 0, 0, CANVAS_SIZE, CANVAS_SIZE);
                try {
                    originalImageData = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                    showMessage("ç·šç¨¿è¼‰å…¥æˆåŠŸï¼ç¾åœ¨å¯ä»¥æ”¾å¤§ä¸¦æ‹–æ›³ç§»å‹•ç•«å¸ƒã€‚", 'info');
                    resetZoom(); 
                } catch (e) {
                    showMessage("ç·šç¨¿è¼‰å…¥æˆåŠŸï¼Œä½†ç”±æ–¼è·¨åŸŸé™åˆ¶ (CORS)ï¼Œç„¡æ³•è®€å–åƒç´ æ•¸æ“šã€‚", 'error');
                    console.error("CORS Error: ç„¡æ³•è®€å–åƒç´ æ•¸æ“šã€‚", e);
                }

                loadingIndicator.classList.add('hidden');
            };
            img.onerror = function() {
                loadingIndicator.classList.add('hidden');
                showMessage(`åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL (${IMAGE_URL}) æ˜¯å¦æœ‰æ•ˆã€‚`, 'error');
            };
            img.src = IMAGE_URL;
        }

        function handleColorChange(newColor) {
            colorPicker.value = newColor;
            let fillColor = hexToRgbaArray(newColor);
            const shade = parseInt(shadeRange.value) / 100;
            fillColor = adjustShade(fillColor, shade);
            selectedColorDisplay.style.backgroundColor = `rgba(${fillColor[0]}, ${fillColor[1]}, ${fillColor[2]}, ${fillColor[3]/255})`;
            
            document.querySelectorAll('.preset-color').forEach(el => {
                el.classList.remove('selected');
            });

            const matchedPreset = document.querySelector(`.preset-color[data-color='${newColor.toUpperCase()}']`);
            if (matchedPreset) {
                matchedPreset.classList.add('selected');
            }
        }

        // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
        window.onload = function() {
            loadImage();
            
            canvas.addEventListener('mousedown', handleDragStart);
            canvas.addEventListener('mousemove', handleDragMove);
            window.addEventListener('mouseup', handleDragEnd); 
            canvas.addEventListener('mouseleave', () => { 
                if (isDragging) handleDragEnd(); 
            });

            canvas.addEventListener('touchstart', handleDragStart);
            canvas.addEventListener('touchmove', handleDragMove);
            window.addEventListener('touchend', handleDragEnd); 

            const presetColorsContainer = document.getElementById('presetColors');
            colorPicker.addEventListener('input', (e) => handleColorChange(e.target.value));

            presetColorsContainer.addEventListener('click', (e) => {
                const colorDiv = e.target.closest('.preset-color');
                if (colorDiv) {
                    const newColor = colorDiv.dataset.color;
                    handleColorChange(newColor);
                }
            });

            toleranceRange.addEventListener('input', (e) => {
                toleranceValueSpan.textContent = e.target.value;
            });

            shadeRange.addEventListener('input', (e) => {
                shadeValueSpan.textContent = e.target.value;
                handleColorChange(colorPicker.value);
            });

            // æ›´å¤šé¡è‰²æŒ‰éˆ•
            const moreColorsBtn = document.getElementById('moreColorsBtn');
            const extraColors = document.getElementById('extraColors');
            moreColorsBtn.addEventListener('click', () => {
                extraColors.classList.toggle('hidden');
                moreColorsBtn.textContent = extraColors.classList.contains('hidden') ? 'æ›´å¤šé¡è‰²' : 'éš±è—é¡è‰²';
            });

            handleColorChange(colorPicker.value);
            document.querySelector('.preset-color').classList.add('selected');
        };
    </script>
</body>
</html>
```
